DEPLOYMENT DOCUMENTATION: ColorMatchGame to Celo Mainnet
=========================================================

Project: ColorMatchGame - A blockchain-based color matching game
Target Network: Celo Mainnet (Chain ID: 42220)
Final Contract Address: 0x286819f4ffc78124c3e74fc9997294af5ee4344d

TIMELINE OF ERRORS AND SOLUTIONS
---------------------------------

ATTEMPT 1: Deploy to Alfajores Testnet
---------------------------------------
Initial Command: npx hardhat ignition deploy ./ignition/modules/ColorMatchGame.ts --network alfajores

Error Encountered:
  ConnectTimeoutError: Connect Timeout Error
  code: 'UND_ERR_CONNECT_TIMEOUT'

Root Cause:
  The Alfajores RPC endpoint (https://alfajores-forno.celo-testnet.org) was not accessible
  from the deployment environment. Network connectivity tests showed the endpoint was timing
  out after 10 seconds.

Diagnosis Steps:
  1. Tested RPC connectivity with curl
     curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' https://alfajores-forno.celo-testnet.org --max-time 10
     Result: Connection timeout after 10 seconds

  2. Verified basic network connectivity
     ping -c 2 8.8.8.8
     Result: Success - basic internet connectivity working

  3. Tested alternative endpoints
     Result: All Alfajores endpoints were inaccessible

Solution:
  Switched target network from Alfajores testnet to Celo mainnet, as the mainnet RPC
  (https://forno.celo.org) was accessible and responding correctly.


ATTEMPT 2: Deploy to Celo Mainnet (First Try)
----------------------------------------------
Command: npx hardhat ignition deploy ./ignition/modules/ColorMatchGame.ts --network celo

Error Encountered:
  ProviderError: invalid argument 0: json: cannot unmarshal hex string without 0x prefix
  into Go value of type common.Address

Root Cause:
  The private key in the .env.local file was missing the "0x" prefix. Hardhat requires
  private keys to be in the format: 0x<hex_string>

Original Format: PRIVATE_KEY=d1fe0463c39c42e648cd0ba840f9a7b1d809964471c690dc2f923577b72d0230
Required Format:  PRIVATE_KEY=0xd1fe0463c39c42e648cd0ba840f9a7b1d809964471c690dc2f923577b72d0230

Diagnosis Steps:
  1. Checked the error message which indicated missing 0x prefix
  2. Examined .env.local file contents
  3. Verified the private key format was incorrect

Solution:
  Updated the private key in .env.local to include the "0x" prefix:
  PRIVATE_KEY=0xd1fe0463c39c42e648cd0ba840f9a7b1d809964471c690dc2f923577b72d0230


ATTEMPT 3: Deploy to Celo Mainnet (Second Try)
-----------------------------------------------
Command: npx hardhat ignition deploy ./ignition/modules/ColorMatchGame.ts --network celo

Error Encountered:
  Same error persisted: "cannot unmarshal hex string without 0x prefix"
  Message showed: "Resuming existing deployment from ./ignition/deployments/chain-42220"

Root Cause:
  Hardhat Ignition was caching the deployment state with the old (incorrect) private key
  format. Even after fixing the .env.local file, the cached state still contained the
  malformed data.

Diagnosis Steps:
  1. Noticed the "Resuming existing deployment" message
  2. Checked ignition/deployments/chain-42220/journal.jsonl
  3. Found the deployment was initialized with incorrect configuration
  4. Multiple attempts to clear cache (rm -rf ignition/deployments/chain-42220) failed
     because the issue was occurring during initial connection, not from cached state

Solution:
  Hardhat Ignition had a deeper compatibility issue with the Celo RPC. The error was
  occurring at the RPC client level when trying to get the transaction count (nonce)
  for the account.


ATTEMPT 4: Environment Variable Loading Issue
----------------------------------------------
Issue: Hardhat wasn't automatically loading .env.local file

Diagnosis Steps:
  1. Realized that Hardhat typically looks for .env, not .env.local
  2. Checked for existence of .env file - none found

Solution:
  Copied .env.local contents to .env:
  cp .env.local .env

  However, this still didn't resolve the Hardhat Ignition issue.


FINAL SOLUTION: Custom Deployment Script Using Viem
----------------------------------------------------
Root Issue Analysis:
  Hardhat Ignition was having compatibility issues with the Celo RPC endpoint at a low
  level. The error occurred during the nonce synchronization phase before actual deployment.

Solution Approach:
  Created a custom deployment script using Viem (a modern Ethereum library) that bypasses
  Hardhat Ignition entirely and deploys the contract directly.

File Created: scripts/deploy.ts

Script Components:
  1. Used viem library for direct blockchain interaction
  2. Loaded private key from environment variable
  3. Created wallet client with Celo chain configuration
  4. Read compiled contract artifact from Hardhat build output
  5. Deployed contract using walletClient.deployContract()
  6. Waited for transaction confirmation
  7. Displayed deployment results

Initial Script Error:
  TypeScript compilation error - missing 'args' property in deployContract parameters

Fix Applied:
  Added args: [] to the deployContract call (empty array since ColorMatchGame constructor
  has no parameters)

Environment Variable Loading:
  ts-node didn't automatically load .env file

Solution:
  Used bash commands to source the .env file before running the script:
  set -a && source .env && set +a && npx ts-node scripts/deploy.ts

SUCCESSFUL DEPLOYMENT
---------------------
Final Command:
  set -a && source .env && set +a && npx ts-node scripts/deploy.ts

Result:
  âœ… ColorMatchGame deployed successfully to Celo mainnet

Deployment Details:
  - Contract Address: 0x286819f4ffc78124c3e74fc9997294af5ee4344d
  - Transaction Hash: 0xfa6358fb3fe90ae82379ea365cc711164108e9eaee68653a62562a95c32445d9
  - Block Number: 51685139
  - Gas Used: 1,773,187
  - Deployer Address: 0x7320f31D71A5294f04f7eEeb101418FEEd3d3119
  - Celoscan Link: https://celoscan.io/address/0x286819f4ffc78124c3e74fc9997294af5ee4344d


KEY LESSONS LEARNED
-------------------
1. Network Accessibility: Always verify RPC endpoint accessibility before attempting
   deployment. Use curl to test endpoints.

2. Private Key Format: Ethereum tooling requires private keys to have "0x" prefix.
   Always verify environment variable format.

3. Tool Compatibility: Hardhat Ignition may have compatibility issues with certain
   networks. Having alternative deployment methods (raw scripts) is valuable.

4. Cache Management: Deployment tools often cache state. When changing configurations,
   clearing caches may not always solve underlying issues.

5. Environment Variables: Different tools load environment variables differently.
   - Hardhat loads .env
   - ts-node doesn't auto-load env files
   - Use explicit sourcing or dotenv packages when needed

6. Direct Deployment: Sometimes the most reliable approach is to write a direct
   deployment script using low-level libraries (viem, ethers) rather than relying
   on framework-specific deployment tools.

7. Error Message Analysis: The "cannot unmarshal hex string without 0x prefix" error
   was misleading - while it initially pointed to the private key format issue, it
   persisted due to deeper RPC client compatibility issues with Hardhat Ignition.


TOOLS AND VERSIONS USED
------------------------
- Hardhat: 2.27.0
- Hardhat Ignition: 0.15.15
- Viem: (installed as part of project dependencies)
- TypeScript: 5.9.3
- ts-node: 10.9.2
- Solidity: 0.8.28
- Node.js: (version in environment)

ALTERNATIVE APPROACHES FOR FUTURE DEPLOYMENTS
----------------------------------------------
1. Use the custom deploy script (scripts/deploy.ts) for reliable deployments
2. Consider using Foundry's forge for deployments (alternative to Hardhat)
3. Use hardhat-deploy plugin instead of Hardhat Ignition
4. Deploy from a different environment with better network access to Alfajores
5. Use a dedicated RPC provider (Infura, Alchemy, QuickNode) instead of public endpoints
